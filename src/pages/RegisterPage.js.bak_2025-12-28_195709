/* Путь: frontend/src/pages/RegisterPage.js
   Назначение: Страница регистрации IzotovLife.
   Примечание: Логику регистрации не трогаем (500 — это бэкенд),
              правки внешнего вида делаем в RegisterPage.module.css.
*/

import React, { useMemo, useState } from "react";
import { Helmet } from "react-helmet-async";
import { Link } from "react-router-dom";
import PasswordField from "../components/PasswordField";
import styles from "./RegisterPage.module.css";
import { register } from "../api/auth";

export default function RegisterPage() {
  const [form, setForm] = useState({
    first_name: "",
    last_name: "",
    email: "",
    password: "",
  });

  const [loading, setLoading] = useState(false);
  const [ok, setOk] = useState(false);
  const [error, setError] = useState("");

  const canSubmit = useMemo(() => {
    const fn = (form.first_name || "").trim();
    const ln = (form.last_name || "").trim();
    const em = (form.email || "").trim();
    const pw = (form.password || "").trim();
    return fn.length > 0 && ln.length > 0 && em.length > 0 && pw.length >= 6;
  }, [form]);

  function onChange(e) {
    const { name, value } = e.target;
    setForm((s) => ({ ...s, [name]: value }));
  }

  async function onSubmit(e) {
    e.preventDefault();
    setError("");
    setLoading(true);
    try {
      await register({
        first_name: (form.first_name || "").trim(),
        last_name: (form.last_name || "").trim(),
        email: (form.email || "").trim().toLowerCase(),
        password: form.password || "",
      });
      setOk(true);
    } catch (err) {
      setError(err?.message || "Ошибка регистрации (проверьте корректность полей).");
      setOk(false);
    } finally {
      setLoading(false);
    }
  }

  return (
    <>
      <Helmet>
        <title>Регистрация — IzotovLife</title>
        <meta
          name="description"
          content="Регистрация на IzotovLife: создайте аккаунт, подтвердите e-mail и получите доступ к кабинету читателя/автора."
        />
        <link rel="canonical" href="https://izotovlife.ru/register" />
      </Helmet>

      <div className={styles.page}>
        <div className={styles.card}>
          <h1 className={styles.title}>Регистрация</h1>

          {ok ? (
            <div className={styles.successBox}>
              <div className={styles.successTitle}>Почти готово ✅</div>
              <div className={styles.successText}>
                Мы отправили письмо на указанный e-mail. Откройте его и нажмите «Подтвердить e-mail», чтобы активировать аккаунт.
              </div>
              <div className={styles.successActions}>
                <Link to="/login" className={styles.linkBtn}>
                  Перейти ко входу
                </Link>
              </div>
            </div>
          ) : (
            <form className={styles.form} onSubmit={onSubmit}>
              <div className={styles.twoCol}>
                <div className={styles.field}>
                  <label className={styles.label}>Имя</label>
                  <input
                    className={styles.input}
                    name="first_name"
                    value={form.first_name}
                    onChange={onChange}
                    placeholder="Иван"
                    autoComplete="given-name"
                  />
                </div>

                <div className={styles.field}>
                  <label className={styles.label}>Фамилия</label>
                  <input
                    className={styles.input}
                    name="last_name"
                    value={form.last_name}
                    onChange={onChange}
                    placeholder="Иванов"
                    autoComplete="family-name"
                  />
                </div>
              </div>

              <div className={styles.field}>
                <label className={styles.label}>E-mail</label>
                <input
                  className={styles.input}
                  name="email"
                  type="email"
                  value={form.email}
                  onChange={onChange}
                  placeholder="you@example.com"
                  autoComplete="email"
                />
              </div>

              <div className={styles.field}>
                <label className={styles.label}>Пароль</label>
                <PasswordField
                  value={form.password}
                  onChange={(v) => setForm((s) => ({ ...s, password: v }))}
                  placeholder="Пароль"
                />
                <div className={styles.hint}>Минимум 6 символов. Лучше: 10+ и смесь букв/цифр.</div>
              </div>

              {error ? <div className={styles.errorBox}>{error}</div> : null}

              <button className={styles.submit} type="submit" disabled={!canSubmit || loading}>
                {loading ? "Отправка..." : "Регистрация"}
              </button>

              <div className={styles.footerLine}>
                Уже есть аккаунт?{" "}
                <Link to="/login" className={styles.link}>
                  Войти
                </Link>
              </div>
            </form>
          )}
        </div>
      </div>
    </>
  );
}
